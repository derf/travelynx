document.addEventListener("DOMContentLoaded",()=>{const s=()=>document.querySelector("div.geolocation div.progress"),m=(e,n,r)=>{const t=document.createElement("a");t.classList.add("tablerow"),t.setAttribute("href",`/s/${e}?hafas=${r}`);const i=parseInt(r)?"directions":"train";return t.innerHTML=`<span><i class="material-icons" aria-hidden="true">${i}</i>${n}</span>`,t.addEventListener("click",()=>document.querySelector("nav .preloader-wrapper").classList.add("active")),t},o=(e,n,r)=>{const t=document.createElement("div");t.classList.add("error"),t.innerText=n;const i=document.createElement("strong");i.innerText=e+" ",t.prepend(i),document.querySelector(".geolocation").append(t);const c=document.querySelector(".geolocation").dataset.recent;if(!c){s().remove();return}const u=c.split("|"),a=document.createElement("p");for(const f of u){const[v,S,E]=f.split(";"),L=m(v,S,E);a.append(L)}document.querySelector("p.geolocationhint").innerText="Letzte Ziele:",s().replaceWith(a)},p=({error:e,candidates:n})=>{if(e){o("Backend-Fehler:",e,null);return}if(!n.length){o("Keine Bahnh\xF6fe in 70km Umkreis gefunden","",null);return}const r=document.createElement("p");for(const t of n){const{eva:i,name:c,hafas:u}=t,a=m(i,c,u);r.appendChild(a)}s().replaceWith(r)},g=({coords:e})=>{fetch("/geolocation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lon:e.longitude,lat:e.latitude})}).then(n=>n.json()).then(p)},h=function(e){e.code==e.PERMISSION_DENIED?o("Standortanfrage nicht m\xF6glich.","Vermutlich fehlen die Rechte im Browser oder der Android Location Service ist deaktiviert.","geolocation.error.PERMISSION_DENIED"):e.code==e.POSITION_UNAVAILABLE?o("Standort konnte nicht ermittelt werden","(Service nicht verf\xFCgbar)","geolocation.error.POSITION_UNAVAILABLE"):e.code==e.TIMEOUT?o("Standort konnte nicht ermittelt werden","(Timeout)","geolocation.error.TIMEOUT"):o("Standort konnte nicht ermittelt werden","(unbekannter Fehler)","unknown geolocation.error code")},d=document.querySelector(".geolocation > button"),l=function(){d.replaceWith('<p class="geolocationhint">Stationen in der Umgebung:</p><div class="progress"><div class="indeterminate"></div></div>'),navigator.geolocation.getCurrentPosition(g,h)};if(!navigator.geolocation){o("Standortanfragen werden von diesem Browser nicht unterst\xFCtzt","",null);return}if(!navigator.permissions){d.addEventListener("click",l);return}navigator.permissions.query({name:"geolocation"}).then(({state:e})=>{if(e==="prompt"){d.addEventListener("click",l);return}l()})});
